import flixel.FlxG;
import flixel.math.FlxAngle;
import funkin.play.PlayState;
import funkin.play.stage.Stage;
import funkin.graphics.shaders.DropShadowShader;
import funkin.play.character.CharacterType;
import openfl.display.BitmapData;

class TankmanBattlefieldErectStage extends Stage
{
	function new()
	{
		super('tankmanBattlefieldErect');
	}

	function onCreate(event:ScriptEvent):Void {
		super.onCreate(event);
	}

	var tankmanRim:DropShadowShader;

	override function addCharacter(character:BaseCharacter, charType:CharacterType):Void {
		// Apply the shader automatically to each character as it gets added.
		super.addCharacter(character, charType);
		trace('Applied stage shader to ' + character.characterName);

		var rim = new DropShadowShader();

    rim.baseBrightness = -46;
    rim.baseHue = -38;
    rim.baseContrast = -25;
    rim.baseSaturation = -20;

    rim.color = 0xFFDFEF3C;

		character.shader = rim;

		rim.attachedSprite = character;

		character.animation.callback = rim.onAttachedFrame;

		switch(charType){
			case CharacterType.BF:

				rim.angle = 90;

			case CharacterType.GF:

				rim.angle = 90;

				trace(getGirlfriend().characterId);

				if(getGirlfriend().characterId == 'gf-tankmen'){
					rim.altMaskImage = BitmapData.fromFile('assets/shared/images/characters/gfTankmen_mask.png');
					rim.maskThreshold = 0.4;
					rim.useAltMask = true;
				}

			case CharacterType.DAD:

				rim.angle = 135;
				rim.threshold = 0.3;

				trace(getDad().characterId);

				if(getDad().characterId == 'tankman-bloody'){
					rim.altMaskImage = BitmapData.fromFile('assets/shared/images/characters/tankmanCaptainBloody_mask.png');
					rim.maskThreshold = 1;
					rim.useAltMask = false;
				}

				// need to save this for later for when the mask is needed
				tankmanRim = rim;

			default:

		}

	}

	/**
	 * Called when the chart hits a song event.
	 */
	public override function onSongEvent(scriptEvent:SongEventScriptEvent)
	{
		super.onSongEvent(scriptEvent);

		if (scriptEvent.eventData.eventKind == "EnableMask" && tankmanRim != null)
		{
			tankmanRim.useAltMask = true;
		}

	}

	override function buildStage()
	{
		super.buildStage();
	}

	function onUpdate(event:UpdateScriptEvent):Void
	{
		super.onUpdate(event);
	}

	function onBeatHit(event:SongTimeScriptEvent):Void
	{
		super.onBeatHit(event);

		if(FlxG.random.bool(2)){
			getNamedProp('sniper').playAnimation('sip', false, true);
		}
	}

	function onSongRetry(event:ScriptEvent)
	{
		super.onSongRetry(event);

		if (tankmanRim != null)
		{
			tankmanRim.useAltMask = false;
		}
	}
}
